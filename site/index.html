<!doctype html>
<html lang="en">
<head>
    <title>X25519 Key Exchange: A Digression</title>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/>
    <meta name="format-detection" content="telephone=no"/>
    <meta name="title" content="The Illustrated X25519 Key Exchange"/>
    <meta name="description" content="An explanation and demonstration of Curve25519 Key Exchange"/>
    <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css"
          integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u"
          crossorigin="anonymous">
    <link rel="stylesheet" href="x25519.css"/>
    <script type="module" async src="site.js"></script>

    <!-- Facebook Meta Tags -->
    <meta property="og:url" content="https://x25519.ulfheim.net/">
    <meta property="og:type" content="website">
    <meta property="og:title" content="The Illustrated X25519 Key Exchange">
    <meta property="og:description" content="An explanation and demonstration of Curve25519 Key Exchange">
    <meta property="og:image" content="https://x25519.ulfheim.net/images/og.png">

    <!-- Twitter Meta Tags -->
    <meta name="twitter:card" content="summary_large_image">
    <meta property="twitter:domain" content="x25519.ulfheim.net">
    <meta property="twitter:url" content="https://x25519.ulfheim.net/">
    <meta name="twitter:title" content="The Illustrated X25519 Key Exchange">
    <meta name="twitter:description" content="An explanation and demonstration of Curve25519 Key Exchange">
    <meta name="twitter:image" content="https://x25519.ulfheim.net/images/og.png">

    <!-- favicons -->
    <link rel="apple-touch-icon" sizes="152x152" href="favicon/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="favicon/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="favicon/favicon-16x16.png">
    <link rel="manifest" href="favicon/site.webmanifest">
    <link rel="mask-icon" href="favicon/safari-pinned-tab.svg" color="#5bbad5">
    <link rel="shortcut icon" href="favicon.ico">
    <meta name="msapplication-TileColor" content="#da532c">
    <meta name="msapplication-config" content="favicon/browserconfig.xml">
    <meta name="theme-color" content="#ffffff">
</head>

<body>
<div class="header">
<a href="https://quic.ulfheim.net">QUIC</a>
<a class="this-page" href="https://x25519.ulfheim.net">X25519</a>
<a href="https://tls13.ulfheim.net">TLS 1.3</a>
<a href="https://tls12.ulfheim.net">TLS 1.2</a>
</div>
<div class="container">
<h1>X25519 Key Exchange</h1>
<h4>Let's exchange a secret to start a secure conversation.</h4>

<div class="section">
<h3>Overview</h3>
<p>Key exchange is a mechanism where two parties can agree on the same number
    without an eavesdropper being able to tell what it is. X25519 is
    the name of one method of key exchange, using the Curve25519 elliptic
    curve.</p>

<p>This method of key exchange works by doing math on an elliptic
    curve, specifically:
    <div class="text-center pb1">
<span class="math">y<sup>2</sup> = x<sup>3</sup> + 486662x<sup>2</sup> + x</span>
</div>

<p>The math operations done on that curve will be in what's called modular
    arithmetic, using the integers
    <span class="math">0</span> through
    <span class="math">2<sup>255</sup>-19</span>.  And with that math, we'll
    be doing a key exchange that looks like this:
    <div class="text-center pb1">
    <span class="math">k<sub>b</sub>*(k<sub>a</sub>*P)
    = k<sub>a</sub>*(k<sub>b</sub>*P)</span>
    </div>

<p>Note that the above is not using simple multiplication.
    It does have properties <i>similar</i> to multiplication, as we'll explain
    below.</p>

<p>Let's give the above terms some better names:
<ul>
    <li><span class="math">k<sub>a</sub></span> - Alice's secret key
        - a 255-bit (~32-byte) random number</li>
    <li><span class="math">k<sub>b</sub></span> - Bob's secret key
        - a 255-bit (~32-byte) random number</li>
    <li><span class="math">P</span> - a point on the curve,
        where <span class="math">x = 9</span></li>
    <li><span class="math">k<sub>a</sub>*P</span> - Alice's public key</li>
    <li><span class="math">k<sub>b</sub>*P</span> - Bob's public key</li>
</ul>
</div>

<div class="section">
<h3>Math on the curve</h3>
<p>This section can be skipped for those that don't need to dig into the math
    of elliptic curves.
<p>A straightforward explanation for elliptic curve math is Andrea Corbellini's <a
            href="https://andrea.corbellini.name/2015/05/17/elliptic-curve-cryptography-a-gentle-introduction/"
    >Elliptic Curve Cryptography: a gentle introduction</a>. That page
    describes a slightly different curve type, but the lessons in it apply here.

<p>The takeaways from that site are:
<p><strong>Point operations</strong> (performed on points on the curve):
<ul>
    <li><em>Adding</em> two points on the curve gives a third point, based on
        the line between two points and its intersection with the
        curve.
    <li>Repeated additions of a point on the curve gives us <em>scalar
    multiplication</em>:
    <br>&nbsp;&nbsp;<span class="math">2P=P+P</span>
    <br>&nbsp;&nbsp;<span class="math">3P=P+P+P</span>
    <br>&nbsp;&nbsp;<span class="math">6P=P+P+P+P+P+P</span>
    <br>&nbsp;&nbsp;... etc.</li>
    <li>Adding points on the curve is <em>associative</em>: adding
        the results of point addition will give the same result
        as adding the component points individually:
        <br>&nbsp;&nbsp;<span class="math">P+P+P+P = 3P+P = 2P+2P = 4P</span>
    </li>
</ul>
<p><strong>Modular arithmetic</strong> (used in curve math when calculating
    addition and multiplication of points above):
<ul>
    <li>Adding, subtracting, and multiplying numbers will
        "wrap around" at the prime <span class="math">p=2<sup>255</sup>-19</span>.
    <li>Division is replaced
    with the multiplicative inverse: instead of dividing by <span class="math">x</span>
    we find the number <span class="math">x<sup>-1</sup></span>
    that satisfies the relationship <span class="math">x*x<sup>-1</sup>=1</span>
    in our prime field, and multiply by that.
</li>
</ul>
</div>

<div class="section">
<h3>Hands on</h3>
<p>Let's play with some actual numbers. This form lets us do point
    multiplication on the base point <span class="math">P</span>, which
    is a point on the curve with coordinate <span class="math">x=9</span>.
</p>

<form id="form-pubkey">
    <div class="form-group">
    <div class="form-row">
    P multiplier
    <button type="button" class="text-right" id="pubkey-plus-one">+1</button>
    <button type="button" class="text-right" id="pubkey-double">Double</button>
    <button type="button" class="text-right" id="pubkey-clamp">Clamp*</button>
    </div>
    </div>
    <div class="form-group">
    <label for="pubkey-privkey">secret key (n):</label>
    <input class="long right squish" id="pubkey-privkey" type="text"
           data-deco="hex-ify" value="0x1">
    </div>
    <div class="form-group">
    <label for="pubkey-result">public key (nP):</label>
    <input class="long right squish" id="pubkey-result" type="text" readonly>
    </div>
</form>

<p>
    <sup>*</sup> See below for an explanation of "Clamp".
</p>

<p>Let's perform a simple key exchange. Give Alice <strong>a secret
    key</strong>, such as "7", and use the calculator above to find Alice's
    <strong>public key</strong>. Give Bob a different <strong>secret
        key</strong>, such as "5", and use the calculator to find Bob's
    <strong>public key</strong>:
<ul>
    <li>Alice's secret key: <span class="math">k<sub>a</sub></span>
        = <span class="squish">7</span>
    <li>Alice's public key: <span class="math">k<sub>a</sub>P</span>
    (<span class="math">7P</span>) =
    <span class="squish">0daf32e7ed8099122b2dfa4c1d8c4a20c0972a1538bf0575338aae0fe0841828</span>
    <li>Bob's secret key: <span class="math">k<sub>b</sub></span>
        = <span class="squish">5</span>
    <li>Bob's public key: <span class="math">k<sub>b</sub>P</span>
    (<span class="math">5P</span>) =
    <span class="squish">41b6ec3c50ee7af203c0026e5e079e7fa8cbc9bc581d49cb0d537d5778497c87</span>
</ul>

<p>Now let's be Alice. Put Alice's secret key
    (<span class="math">k<sub>a</sub></span>) into the calculator below,
    and multiply it by Bob's public key
    (<span class="math">k<sub>b</sub>P</span>).
<ul>
    <li>Shared secret: <span class="math">k<sub>a</sub>k<sub>b</sub>P</span>
    (<span class="math">35P</span>) =
    <span class="squish">1b9b715c415e547a13ca98a9f561d54499cc7402a1098414eddcfaf83ffbe3f8</span>
    </li>
</ul>

<form id="form-mult">
    <div class="form-group">
    Other point multiplier
    <br>
    <label for="mult-n">multiplier:</label>
    <input class="long right squish" id="mult-n" type="text"
           data-deco="hex-ify" placeholder="multiplier">
    </div>
    <div class="form-group">
    <label for="mult-point">point:</label>
    <input class="long right squish" id="mult-point" type="text"
           data-deco="hex-ify" placeholder="point">
    </div>
    <div class="form-group">
    <label for="mult-result">new point:</label>
    <input class="long right squish" id="mult-result" type="text"
           placeholder="result" readonly>
    </div>
</form>

<p>Let's switch over to Bob. Put Bob's secret key
    (<span class="math">k<sub>b</sub></span>) into the calculator, and
    multiply it by Alice's public key
    (<span class="math">k<sub>a</sub>P</span>).
    The result matches, because
    <span class="math">k<sub>a</sub>k<sub>b</sub>P = k<sub>b</sub>k<sub>a
    </sub>P = 35P</span>!
</p>

<p>Since the eavesdropper can't see either of Alice or Bob's secret keys,
    they can't compute the same result.
</p>
</div>

<div class="section">
<h3>Odds and ends</h3>
<p><span class="qa">Q:</span> Why can't I reproduce
    these
    results in
    <span class="tt">openssl</span> or other tools?

<p><span class="qa">A:</span> The likely reason is that
    private
    keys
    in Curve25519
    are modified slightly to avoid insecure keys and timing attacks (see
    section 4.7 "Clamping" in <a href="https://martin.kleppmann.com/papers/curve25519.pdf"
    >Implementing Curve25519/X25519</a> by Martin Kleppmann).
    In particular the following five bits are clamped to
    pre-determined values in real implementations (click the "Clamp" button
    to apply these bit values to your key):
<table class="table table-condensed">
    <thead>
    <tr><th>Bit</th><th>Value</th><th>Reason</th></tr>
    </thead>
    <tr><td>0</td><td>0</td><td>Small-subgroup attacks</td></tr>
    <tr><td>1</td><td>0</td><td>Small-subgroup attacks</td></tr>
    <tr><td>2</td><td>0</td><td>Small-subgroup attacks</td></tr>
    <tr><td>254</td><td>1</td><td>Protect against timing leak</td></tr>
    <tr><td>255</td><td>0</td><td>n < 2<sup>255</sup></td></tr>
</table>

<p>You may still find that your output does not match
    because X25519 keys are stored and transmitted in little-endian
    order while this page displays them in as numbers which are
    usually interpreted as big-endian.</p>

<p><span class="qa">Q:</span> If these are points in
    an x-y
    curve,
    where are
    the y coordinates?

<p><span class="qa">A:</span> The curve is symmetric on the y-axis, and each point
    on the curve
    <span class="math">(x, y)</span> has a corresponding inverted point
    <span class="math">(x, -y)</span>. For simplicity in implementation and
    to reduce key length only the <span class="math">x</span> coordinate of
    each point is computed.</p>

<p>Some other EC mechanisms do make use of both
    <span class="math">x</span> and <span class="math">y</span> coordinates.

<p><span class="qa">Q:</span> Can you give me more details on elliptic curve
                    operations?</p>

<p><span class="qa">A:</span> I found the <a
        href="https://en.wikipedia.org/wiki/Elliptic_curve_point_multiplication"
>Wikipedia page on EC point multiplication</a> useful, in particular the
    section on Montgomery ladders, which Curve25519 is designed around the
    use of. The <a href="https://en.wikipedia.org/wiki/Montgomery_curve#Montgomery_arithmetic"
    >Wikipedia page on Montgomery curves</a> also has equations for addition and
    doubling. <a
            href="https://datatracker.ietf.org/doc/html/rfc7748">RFC 7748</a>
    was also useful as it gives straightforward steps for performing
    Curve25519 multiplication in constant time with a Montgomery ladder.</p>
</div>
</div>
</body>
</html>
